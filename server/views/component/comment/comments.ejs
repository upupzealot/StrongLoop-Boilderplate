<style type="text/css">
.comment-info {
  color: #ccc;
  margin-bottom: 5px;
  font-size: .9em;
}
.comment-info.bottom {
  margin-bottom: 0;
}
.comment-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  margin-top: 5px;
  margin-right: 10px;
}
.comment-content {
  margin: 0 46px;
}

.panel-fifs {
  margin: 5px 0 10px;
}
.fif-item {
  background-color: #f5f5f5;
}
.fif-item p {
  margin-bottom: 5px;
}
.fif-form {
  padding: 10px 15px;
  border-top: #ddd solid 1px;
  border-bottom-left-radius: 4px;
  border-bottom-right-radius: 4px;
}
.list-section:first-child .fif-form {
  border-top: none;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
}
</style>

<div class="panel panel-default">
  <div class="panel-heading">
    共 <%- comments.length %> 条
  </div>
  <% if(comments.length) { %>
  <ul class="list-group">
    <% comments.map(function(comment) { %>
      <li class="list-group-item comment-item" data-id="<%- comment.id %>">
        <img src="<%- comment.creator.avatar %>" class="comment-avatar pull-left">
        <div class="comment-content">
          <div class="comment-info">
            <a><%- comment.creator.username %></a>
            | <%- moment(comment.created_at).locale('zh-cn').fromNow() %>
          </div>

          <%- comment.content %>


          <!-- 楼中楼 -->
          <div class="comment-info bottom">
              <% if(comment.comments.length) { %>
                <a data-toggle="collapse"
                href="#comment-<%- comment.id %>-fifs">
                  回复 (<%- comment.comments.length %>)
                </a> |
              <% } %>
              <a class="fif-form-toggle-btn" data-toggle="collapse"
                href="#comment-<%- comment.id %>-fif-create">发表回复</a>
          </div>

          <div class="collapse
          <%- comment.comments.length ? 'in' : ''; %>"
          id="comment-<%- comment.id %>-fifs">
            <div class="panel-fifs panel panel-default">
              <% if(comment.comments.length) { %>
              <ul class="list-group list-section">
                <% comment.comments.map(function(fif) { %>
                  <li class="list-group-item fif-item">
                    <img src="<%- fif.creator.avatar %>" class="comment-avatar pull-left">
                    <div class="comment-content">
                      <div class="comment-info">
                        <a><%- fif.creator.username %></a>
                        | <%- moment(fif.created_at).locale('zh-cn').fromNow() %>
                      </div>
                      <p><%- fif.content %></p>
                      <div class="comment-info bottom">
                        <a class="fif-reply-btn"
                        data-id="<%- fif.id %>"
                        data-creator-username="<%- fif.creator.username %>"
                        data-toggle="collapse"
                        href="#comment-<%- comment.id %>-fif-create">
                          回复
                        </a>
                      </div>
                    </div>
                  </li>
                <% }); %>
              </ul>
              <% } %>

              <!-- 楼中楼表单 -->
              <div class="collapse list-section
              <%- comment.comments.length ? '' : 'in'; %>"
              id="comment-<%- comment.id %>-fif-create">
                <div class="fif-item fif-form clearfix">
                  <% if(locals.user) { %>
                    <img src="<%- user.avatar %>" class="comment-avatar pull-left">
                    <div class="comment-content">
                      <div class="comment-info">新回复</div>
                      <%- include(_v + '/component/form/form', {
                        opt: {
                          id: 'comment-' + comment.id + '-fif-create',
                          fields: [{
                            name: 'replied_id',
                            hidden: true,
                            type: 'number',
                          },{
                            name: 'content',
                            vali: 'notEmpty',
                          }],
                          beforeSubmit: function(data) {
                            if(data.replied_id == 0) {
                              delete data.replied_id;
                            }
                            return data;
                          },
                          submit: {
                            btn: '#comment-' + comment.id + '-fif-submit-btn',
                            url: '/api/Comments/' + comment.id + '/comments',
                          },
                        },
                      }); %>
                      <button class="btn btn-primary btn-sm pull-right"
                      id="comment-<%- comment.id %>-fif-submit-btn"
                      style="margin-top: -5px;">
                        发表回复
                      </button>
                    </div>
                  <% } else { %>
                    <div style="text-align: center; padding: 20px;">
                      请先 <a href="/login">登陆</a>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </li>
    <% }); %>
  </ul>
  <% } %>
</div>

<script type="text/javascript">
$(function() {
  $('.comment-item').each(function(index, fif) {
    var $commentItem = $(this);
    var id = $commentItem.data('id');

    var $fifFormCollapse = $commentItem.find('.fif-form').closest('.collapse');
    var $repliedInfo = $commentItem.find('.fif-form .comment-info');
    
    var fifCreateForm = $commentItem.find('#comment-' + id + '-fif-create').c();
    if(fifCreateForm) {
      var repliedIdField = fifCreateForm.fieldComponents.replied_id;
      var $fifFormToggleBtn = $commentItem.find('.fif-form-toggle-btn');
      var $fifReplyBtn = $commentItem.find('.fif-reply-btn');

      $fifFormToggleBtn.on('click', function() {
        if(repliedIdField.val() != 0) {
          repliedIdField.val(0);
          $repliedInfo.text('新回复');
          if($fifFormCollapse.hasClass('in')) {
            return false;
          }
        }
      });
      $fifReplyBtn.on('click', function() {
        var $this = $(this);
        var id = $this.data('id');
        if(repliedIdField.val() != id) {
          repliedIdField.val(id);
          $repliedInfo.text('回复 ' + $this.data('creator-username'));
          if($fifFormCollapse.hasClass('in')) {
            return false;
          }
        }
      });
    }

    var $fifsCollapse = $commentItem.find('.panel-fifs').closest('.collapse');
    var fifCount = $fifsCollapse.find('ul.list-group li.list-group-item').length;
    
    if(!fifCount) {
      $fifFormCollapse.on('toggle.bs.collapse', function() {
        $fifsCollapse.collapse('toggle');
        return false;
      }).on('hide.bs.collapse', function() {
        $fifsCollapse.collapse('toggle');
        return false;
      });
    } else {
      $fifFormCollapse.on('show.bs.collapse', function() {
        if(!$fifsCollapse.hasClass('in')) {
          $fifsCollapse.one('shown.bs.collapse', function() {
            $fifFormCollapse.collapse('show');
          });
          $fifsCollapse.collapse('show');
          return false;
        }
      }).on('hide.bs.collapse', function() {
        if(!$fifsCollapse.hasClass('in')) {
          $fifsCollapse.collapse('show');
          return false;
        }
      });
    }
  });
});
</script>
